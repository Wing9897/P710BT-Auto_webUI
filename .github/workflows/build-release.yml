name: ğŸ”¨ Build & Release

on:
  push:
    branches: [main, master]
    paths-ignore:
      - "**.md"
      - ".gitignore"
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬è™Ÿ (ä¾‹å¦‚ v1.0.0)ï¼Œç•™ç©ºå‰‡è‡ªå‹•ç”Ÿæˆ"
        required: false
        default: ""

permissions:
  contents: write

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1. è‡ªå‹•ç”Ÿæˆç‰ˆæœ¬ Tag
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  auto-tag:
    name: ğŸ·ï¸ Auto Tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.tag.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            DATE=$(date +'%Y.%m.%d')
            COUNT=$(git rev-list --count HEAD)
            VERSION="v${DATE}.${COUNT}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "âœ… Version: ${VERSION}"

      - name: Create & push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # è‹¥ tag å·²å­˜åœ¨ï¼ˆé‡è·‘åŒä¸€ commitï¼‰å‰‡è·³éï¼Œå…¶ä»–éŒ¯èª¤ä»ä¸­æ­¢
          if git rev-parse "refs/tags/${{ steps.tag.outputs.version }}" >/dev/null 2>&1; then
            echo "âš ï¸ Tag ${{ steps.tag.outputs.version }} already exists, skipping"
          else
            git tag "${{ steps.tag.outputs.version }}"
            git push origin "${{ steps.tag.outputs.version }}"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2. å¤šå¹³å° Nuitka æ‰“åŒ…
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: ğŸ› ï¸ Build [${{ matrix.name }}]
    needs: auto-tag
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows x64
          - os: windows-latest
            name: windows-x64

          # Linux x64
          - os: ubuntu-22.04
            name: linux-x64

          # Linux ARM64 (GitHub native ARM64 runner)
          - os: ubuntu-22.04-arm
            name: linux-arm64

          # macOS Apple Silicon (ARM64)
          - os: macos-latest
            name: macos-arm64

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # â”€â”€ Linux ç³»çµ±ä¾è³´ â”€â”€
      - name: Install system deps (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            libgl1 \
            libusb-1.0-0-dev \
            libxcb-cursor0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-render-util0 \
            libxcb-xinerama0 \
            libxcb-xkb1 \
            libxkbcommon-x11-0 \
            patchelf \
            qt6-base-dev \
            qmake6 \
            imagemagick

      # â”€â”€ macOS ç³»çµ±ä¾è³´ â”€â”€
      - name: Install system deps (macOS)
        if: runner.os == 'macOS'
        run: brew install libusb

      # â”€â”€ Python å¥—ä»¶ â”€â”€
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install --prefer-binary -r backend/requirements.txt

      # â”€â”€ macOS libusb fix (éœ€åœ¨ pip install ä¹‹å¾Œï¼Œlibusb_package æ‰å­˜åœ¨) â”€â”€
      - name: Fix libusb dylib for Nuitka (macOS)
        if: runner.os == 'macOS'
        run: |
          LIBUSB_PKG=$(python -c "import libusb_package, os; print(os.path.dirname(libusb_package.__file__))")
          cp -L "$(brew --prefix libusb)/lib/libusb-1.0.0.dylib" "$LIBUSB_PKG/libusb-1.0.dylib"
          install_name_tool -id "@loader_path/libusb-1.0.dylib" "$LIBUSB_PKG/libusb-1.0.dylib"

      # â”€â”€ Nuitka æ‰“åŒ… (å…¨å¹³å°) â”€â”€
      # windows-console-mode åœ¨ macOS/Linux æœƒè¢«å¿½ç•¥ï¼Œç„¡éœ€åˆ†é–‹å…©å€‹ step
      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: main_desktop.py
          enable-plugins: pyside6
          include-package: |
            app
            usb
            libusb_package
          include-package-data: libusb_package
          windows-console-mode: disable
          output-dir: build
        env:
          PYTHONPATH: ./backend

      # â”€â”€ æº–å‚™è¼¸å‡ºç›®éŒ„ â”€â”€
      - name: Prepare output directory
        shell: bash
        run: mkdir -p dist-files

      # â”€â”€ Windows æ‰“åŒ…ï¼športable zip + Inno Setup installer â”€â”€
      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          VERSION="${{ needs.auto-tag.outputs.version }}"
          # Portable zip
          (cd build/main_desktop.dist && 7z a "../../dist-files/P710BT-Auto-windows-x64.zip" . > /dev/null)
          # Inno Setup installer (.exe)
          cat > setup.iss << EOF
          [Setup]
          AppName=P710BT-Auto
          AppVersion=${VERSION}
          DefaultDirName={autopf}\\P710BT-Auto
          DefaultGroupName=P710BT-Auto
          OutputDir=dist-files
          OutputBaseFilename=P710BT-Auto-windows-x64-setup
          Compression=lzma
          SolidCompression=yes
          WizardStyle=modern
          [Files]
          Source: "build\\main_desktop.dist\\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs
          [Icons]
          Name: "{group}\\P710BT-Auto"; Filename: "{app}\\main_desktop.exe"
          Name: "{commondesktop}\\P710BT-Auto"; Filename: "{app}\\main_desktop.exe"
          [Run]
          Filename: "{app}\\main_desktop.exe"; Description: "Launch P710BT-Auto"; Flags: nowait postinstall skipifsilent
          EOF
          "/c/Program Files (x86)/Inno Setup 6/ISCC.exe" setup.iss

      # â”€â”€ Linux æ‰“åŒ…ï¼šAppImage + deb â”€â”€
      - name: Package (Linux)
        if: runner.os == 'Linux'
        run: |
          ARCH=$(uname -m)
          NAME="${{ matrix.name }}"
          VERSION="${{ needs.auto-tag.outputs.version }}"
          DEB_VERSION="${VERSION#v}"
          case "$ARCH" in x86_64) DEB_ARCH="amd64" ;; aarch64) DEB_ARCH="arm64" ;; esac

          # AppImage
          wget -q "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-${ARCH}.AppImage" -O appimagetool
          chmod +x appimagetool
          mkdir -p AppDir
          cp -r build/main_desktop.dist/* AppDir/
          printf '#!/bin/bash\nHERE="$(dirname "$(readlink -f "$0")")"\nexec "${HERE}/main_desktop" "$@"\n' > AppDir/AppRun
          chmod +x AppDir/AppRun
          printf '[Desktop Entry]\nName=P710BT-Auto\nExec=main_desktop\nIcon=main_desktop\nType=Application\nCategories=Utility;\n' > AppDir/main_desktop.desktop
          convert -size 256x256 xc:#1565C0 AppDir/main_desktop.png
          ARCH=$ARCH APPIMAGE_EXTRACT_AND_RUN=1 ./appimagetool AppDir "dist-files/P710BT-Auto-${NAME}.AppImage"

          # DEB
          PKG="pkg-deb"
          mkdir -p "${PKG}/DEBIAN" "${PKG}/usr/local/lib/p710bt-auto" "${PKG}/usr/local/bin" "${PKG}/usr/share/applications"
          cp -r build/main_desktop.dist/* "${PKG}/usr/local/lib/p710bt-auto/"
          printf '#!/bin/bash\nexec /usr/local/lib/p710bt-auto/main_desktop "$@"\n' > "${PKG}/usr/local/bin/p710bt-auto"
          chmod +x "${PKG}/usr/local/bin/p710bt-auto"
          printf '[Desktop Entry]\nName=P710BT-Auto\nExec=p710bt-auto\nIcon=p710bt-auto\nType=Application\nCategories=Utility;\n' > "${PKG}/usr/share/applications/p710bt-auto.desktop"
          printf "Package: p710bt-auto\nVersion: ${DEB_VERSION}\nArchitecture: ${DEB_ARCH}\nMaintainer: Wing9897\nDescription: Brother Label Printer Desktop Tool\n" > "${PKG}/DEBIAN/control"
          dpkg-deb --build "${PKG}" "dist-files/P710BT-Auto-${NAME}.deb"

      # â”€â”€ macOS æ‰“åŒ…ï¼šDMG â”€â”€
      - name: Package (macOS)
        if: runner.os == 'macOS'
        run: |
          hdiutil create -volname "P710BT-Auto" \
            -srcfolder "build/main_desktop.app" \
            -ov -format UDZO \
            "dist-files/P710BT-Auto-${{ matrix.name }}.dmg"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: dist-files/
          retention-days: 1

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 3. è‡ªå‹•å»ºç«‹ GitHub Release
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release:
    name: ğŸš€ Create Release
    needs: [auto-tag, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          path: release-files

      - name: List release files
        run: ls -lh release-files/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.auto-tag.outputs.version }}
          name: "ğŸš€ Release ${{ needs.auto-tag.outputs.version }}"
          draft: false
          prerelease: false
          generate_release_notes: true
          files: release-files/*
          body: |
            ## ğŸ“¦ P710BT-Auto WebUI â€” ${{ needs.auto-tag.outputs.version }}

            ### æ”¯æ´å¹³å° / Supported Platforms

            | å¹³å° | æ¶æ§‹ | æ ¼å¼ | æª”æ¡ˆ |
            |------|------|------|------|
            | Windows | x64 | å…å®‰è£ portable | `P710BT-Auto-windows-x64.zip` |
            | Windows | x64 | å®‰è£ç¨‹å¼ | `P710BT-Auto-windows-x64-setup.exe` |
            | Linux | x64 | AppImage (å…å®‰è£) | `P710BT-Auto-linux-x64.AppImage` |
            | Linux | x64 | DEB å®‰è£åŒ… | `P710BT-Auto-linux-x64.deb` |
            | Linux | arm64 | AppImage (å…å®‰è£) | `P710BT-Auto-linux-arm64.AppImage` |
            | Linux | arm64 | DEB å®‰è£åŒ… | `P710BT-Auto-linux-arm64.deb` |
            | macOS | arm64 (Apple Silicon + Intel via Rosetta 2) | DMG | `P710BT-Auto-macos-arm64.dmg` |

            ### ä½¿ç”¨èªªæ˜
            - **Windows (portable)**: è§£å£“ç¸® `.zip`ï¼ŒåŸ·è¡Œ `main_desktop.exe`
            - **Windows (installer)**: åŸ·è¡Œ `setup.exe`ï¼Œä¾æŒ‡ç¤ºå®‰è£ï¼Œæ¡Œé¢æœƒå‡ºç¾æ·å¾‘
            - **Linux AppImage**: `chmod +x *.AppImage` å¾Œç›´æ¥åŸ·è¡Œ
            - **Linux DEB**: `sudo dpkg -i *.deb` å¾ŒåŸ·è¡Œ `p710bt-auto`
            - **macOS**: é–‹å•Ÿ `.dmg`ï¼Œé›™æ“Š `main_desktop.app`
